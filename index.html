<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Pulse: Music Runner</title>
    <style>
        :root { --neon-pink: #ff00ff; --neon-cyan: #00ffff; --bg: #050505; }
        body { margin: 0; overflow: hidden; background: var(--bg); color: white; font-family: 'Courier New', monospace; touch-action: none; }
        canvas { display: block; filter: blur(0.5px) contrast(1.2); }

        #hud { position: fixed; top: 20px; width: 100%; display: flex; justify-content: space-around; z-index: 100; pointer-events: none; }
        .stat { background: rgba(0,0,0,0.8); padding: 10px 20px; border: 2px solid var(--neon-cyan); border-radius: 5px; box-shadow: 0 0 15px var(--neon-cyan); }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; text-align: center; }
        h1 { font-size: 50px; text-shadow: 0 0 20px var(--neon-pink); margin-bottom: 10px; }
        button { padding: 15px 60px; font-size: 22px; background: transparent; border: 2px solid var(--neon-pink); color: var(--neon-pink); cursor: pointer; transition: 0.3s; box-shadow: 0 0 10px var(--neon-pink); }
        button:hover { background: var(--neon-pink); color: white; }
    </style>
</head>
<body onclick="handleAction()">

<div id="hud">
    <div class="stat">PULSE: <span id="dist">0</span></div>
    <div class="stat">RC: <span id="rc">0</span></div>
</div>

<div id="start-screen" class="overlay">
    <h1>THE PULSE</h1>
    <p>Tap to JUMP. Follow the rhythm!<br>Avoid dark blocks and collect light sparks.</p>
    <button onclick="initPulse(event)">SYNC START</button>
</div>

<canvas id="pulseCanvas"></canvas>

<script>
    const canvas = document.getElementById('pulseCanvas');
    const ctx = canvas.getContext('2d');
    let gameActive = false, score = 0, rc = 0;
    
    const player = { x: 80, y: 0, w: 40, h: 40, dy: 0, jumping: false, ground: 0 };
    let obstacles = [], particles = [];

    // --- PROCEDURAL MUSIC ENGINE ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playBeat(freq, type, dur, vol, timeOffset = 0) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime + timeOffset);
        osc.connect(gain); gain.connect(audioCtx.destination);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime + timeOffset);
        gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur + timeOffset);
        osc.start(audioCtx.currentTime + timeOffset);
        osc.stop(audioCtx.currentTime + dur + timeOffset);
    }

    function musicLoop() {
        if(!gameActive) return;
        // Bass Kick
        playBeat(60, 'sine', 0.2, 0.4);
        // Snare/Clap
        playBeat(800, 'square', 0.05, 0.05, 0.5);
        
        // Spawn obstacle exactly on the beat
        spawnObstacle();
        
        setTimeout(musicLoop, 1000); // 60 BPM
    }

    function initPulse(e) {
        e.stopPropagation();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        document.getElementById('start-screen').style.display = 'none';
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        player.ground = canvas.height - 150;
        player.y = player.ground;

        gameActive = true;
        musicLoop();
        update();
    }

    function handleAction() {
        if(!gameActive) return;
        if(!player.jumping) {
            player.dy = -18;
            player.jumping = true;
            playBeat(400, 'triangle', 0.2, 0.1);
        }
    }

    function spawnObstacle() {
        obstacles.push({ x: canvas.width, y: player.ground, w: 40, h: 60, passed: false });
    }

    function update() {
        if(!gameActive) return;

        // Visual background pulse
        ctx.fillStyle = `rgba(5, 5, 5, 0.3)`;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Draw Floor line
        ctx.strokeStyle = varColor('--neon-cyan');
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(0, player.ground + 40);
        ctx.lineTo(canvas.width, player.ground + 40);
        ctx.stroke();

        // Player Physics
        player.dy += 0.8;
        player.y += player.dy;
        if(player.y > player.ground) {
            player.y = player.ground;
            player.dy = 0;
            player.jumping = false;
        }

        // Draw Player (Spark)
        ctx.shadowBlur = 15;
        ctx.shadowColor = varColor('--neon-pink');
        ctx.fillStyle = varColor('--neon-pink');
        ctx.fillRect(player.x, player.y, player.w, player.h);
        ctx.shadowBlur = 0;

        // Obstacles
        obstacles.forEach((obs, i) => {
            obs.x -= 6;
            ctx.fillStyle = '#333';
            ctx.strokeStyle = varColor('--neon-cyan');
            ctx.lineWidth = 2;
            ctx.strokeRect(obs.x, obs.y, obs.w, obs.h);
            ctx.fillRect(obs.x, obs.y, obs.w, obs.h);

            // Collision
            if(player.x < obs.x + obs.w && player.x + player.w > obs.x && 
               player.y < obs.y + obs.h && player.y + player.h > obs.y) {
                gameOver();
            }

            if(obs.x < -50) obstacles.splice(i, 1);
        });

        score++;
        document.getElementById('dist').innerText = Math.floor(score/10);
        requestAnimationFrame(update);
    }

    function varColor(name) { return getComputedStyle(document.documentElement).getPropertyValue(name); }

    function gameOver() {
        gameActive = false;
        playBeat(50, 'sawtooth', 0.5, 0.2);
        alert(`PULSE LOST!\nSync Level: ${Math.floor(score/10)}\nRC Earned: ${Math.floor(score/50)}`);
        location.reload();
    }
</script>
</body>
</html>